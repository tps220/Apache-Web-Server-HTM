\hypertarget{group__Cache__storage}{}\section{Cache Storage Functions}
\label{group__Cache__storage}\index{Cache Storage Functions@{Cache Storage Functions}}
Collaboration diagram for Cache Storage Functions\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=311pt]{group__Cache__storage}
\end{center}
\end{figure}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{pcre_8txt_a42dfa4ff673c82d8efe7144098fbc198}{int} \hyperlink{group__Cache__storage_ga099a01e4f8a6d68cc94a47adde527489}{cache\+\_\+remove\+\_\+url} (\hyperlink{structcache__request__rec}{cache\+\_\+request\+\_\+rec} $\ast$\hyperlink{structcache}{cache}, \hyperlink{structrequest__rec}{request\+\_\+rec} $\ast$\hyperlink{pcregrep_8txt_a2e9e9438b26c0bb4425367a7e4f75eb3}{r})
\item 
\hyperlink{pcre_8txt_a42dfa4ff673c82d8efe7144098fbc198}{int} \hyperlink{group__Cache__storage_gaa8317a8938235881e7f1368031b33bb9}{cache\+\_\+create\+\_\+entity} (\hyperlink{structcache__request__rec}{cache\+\_\+request\+\_\+rec} $\ast$\hyperlink{structcache}{cache}, \hyperlink{structrequest__rec}{request\+\_\+rec} $\ast$\hyperlink{pcregrep_8txt_a2e9e9438b26c0bb4425367a7e4f75eb3}{r}, \hyperlink{group__apr__platform_ga6938af9075cec15c88299109381aa984}{apr\+\_\+off\+\_\+t} \hyperlink{README_8txt_a870076999eb1486aa63d2e2cf5cdfa55}{size}, \hyperlink{structapr__bucket__brigade}{apr\+\_\+bucket\+\_\+brigade} $\ast$\hyperlink{group__apr__thread__proc_ga2e46fea00cc2238744ebca5061c62bcc}{in})
\item 
\hyperlink{pcre_8txt_a42dfa4ff673c82d8efe7144098fbc198}{int} \hyperlink{group__Cache__storage_gaffb29f2e1276bc7d81bac540a1cf3e06}{cache\+\_\+select} (\hyperlink{structcache__request__rec}{cache\+\_\+request\+\_\+rec} $\ast$\hyperlink{structcache}{cache}, \hyperlink{structrequest__rec}{request\+\_\+rec} $\ast$\hyperlink{pcregrep_8txt_a2e9e9438b26c0bb4425367a7e4f75eb3}{r})
\item 
\hyperlink{pcre_8txt_a42dfa4ff673c82d8efe7144098fbc198}{int} \hyperlink{group__Cache__storage_ga8579a258895a1e158ebe9e61deb15d9a}{cache\+\_\+invalidate} (\hyperlink{structcache__request__rec}{cache\+\_\+request\+\_\+rec} $\ast$\hyperlink{structcache}{cache}, \hyperlink{structrequest__rec}{request\+\_\+rec} $\ast$\hyperlink{pcregrep_8txt_a2e9e9438b26c0bb4425367a7e4f75eb3}{r})
\item 
\hyperlink{group__apr__errno_gaa5105fa83cc322f09382292db8b47593}{apr\+\_\+status\+\_\+t} \hyperlink{group__Cache__storage_ga9b9cd90883d10b4e8f021c0cc371a823}{cache\+\_\+generate\+\_\+key\+\_\+default} (\hyperlink{structrequest__rec}{request\+\_\+rec} $\ast$\hyperlink{pcregrep_8txt_a2e9e9438b26c0bb4425367a7e4f75eb3}{r}, \hyperlink{structapr__pool__t}{apr\+\_\+pool\+\_\+t} $\ast$\hyperlink{group__APACHE__CORE__MPM_ga5cd91701e5c167f2b1a38e70ab57817e}{p}, const char $\ast$$\ast$\hyperlink{apr__siphash_8h_adac0b6a30345ea1d0daa8a692b0b7ad9}{key})
\item 
\hyperlink{group__MOD__ISAPI_gacd6cdbf73df3d9eed42fa493d9b621a6}{void} \hyperlink{group__Cache__storage_ga0b273ea1fdda33adc7ecf2e47e4a57a7}{cache\+\_\+accept\+\_\+headers} (\hyperlink{group__MOD__CACHE_ga6b7854a2592838a565bdee8f94343aab}{cache\+\_\+handle\+\_\+t} $\ast$\hyperlink{pcregrep_8txt_a373589baca2cb79ec87f46d6599640b9}{h}, \hyperlink{structrequest__rec}{request\+\_\+rec} $\ast$\hyperlink{pcregrep_8txt_a2e9e9438b26c0bb4425367a7e4f75eb3}{r}, \hyperlink{structapr__table__t}{apr\+\_\+table\+\_\+t} $\ast$top, \hyperlink{structapr__table__t}{apr\+\_\+table\+\_\+t} $\ast$bottom, \hyperlink{pcre_8txt_a42dfa4ff673c82d8efe7144098fbc198}{int} revalidation)
\end{DoxyCompactItemize}


\subsection{Detailed Description}


\subsection{Function Documentation}
\index{Cache Storage Functions@{Cache Storage Functions}!cache\+\_\+accept\+\_\+headers@{cache\+\_\+accept\+\_\+headers}}
\index{cache\+\_\+accept\+\_\+headers@{cache\+\_\+accept\+\_\+headers}!Cache Storage Functions@{Cache Storage Functions}}
\subsubsection[{\texorpdfstring{cache\+\_\+accept\+\_\+headers(cache\+\_\+handle\+\_\+t $\ast$h, request\+\_\+rec $\ast$r, apr\+\_\+table\+\_\+t $\ast$top, apr\+\_\+table\+\_\+t $\ast$bottom, int revalidation)}{cache_accept_headers(cache_handle_t *h, request_rec *r, apr_table_t *top, apr_table_t *bottom, int revalidation)}}]{\setlength{\rightskip}{0pt plus 5cm}{\bf void} cache\+\_\+accept\+\_\+headers (
\begin{DoxyParamCaption}
\item[{{\bf cache\+\_\+handle\+\_\+t} $\ast$}]{h, }
\item[{{\bf request\+\_\+rec} $\ast$}]{r, }
\item[{{\bf apr\+\_\+table\+\_\+t} $\ast$}]{top, }
\item[{{\bf apr\+\_\+table\+\_\+t} $\ast$}]{bottom, }
\item[{{\bf int}}]{revalidation}
\end{DoxyParamCaption}
)}\hypertarget{group__Cache__storage_ga0b273ea1fdda33adc7ecf2e47e4a57a7}{}\label{group__Cache__storage_ga0b273ea1fdda33adc7ecf2e47e4a57a7}
Merge in cached headers into the response 
\begin{DoxyParams}{Parameters}
{\em h} & cache\+\_\+handle\+\_\+t \\
\hline
{\em r} & \hyperlink{structrequest__rec}{request\+\_\+rec} \\
\hline
{\em top} & headers to be applied \\
\hline
{\em bottom} & headers to be overwritten \\
\hline
{\em revalidation} & true if revalidation is taking place\\
\hline
\end{DoxyParams}
Take two sets of headers, sandwich them together, and apply the result to r-\/$>$headers\+\_\+out.

To complicate this, a header may be duplicated in either table. Should a header exist in the top table, all matching headers will be removed from the bottom table before the headers are combined. The Warning headers are handled specially. Warnings are added rather than being replaced, while in the case of revalidation 1xx Warnings are stripped.

The Content-\/\+Type and Last-\/\+Modified headers are then re-\/parsed and inserted into the request. 
\begin{DoxyCode}
174 \{
175     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *\hyperlink{pcregrep_8txt_ac2002bf2124e804678bf3ccba93693c5}{v};
176 
177     \textcolor{keywordflow}{if} (revalidation) \{
178         r->\hyperlink{structrequest__rec_a0fd560d8d1118304dc33df8ee99efc04}{headers\_out} = apr\_table\_make(r->\hyperlink{structrequest__rec_aa0a0c16f9a9ab3901cdb3f3c9c9d83d0}{pool}, 10);
179         apr\_table\_do(filter\_header\_do, r->\hyperlink{structrequest__rec_a0fd560d8d1118304dc33df8ee99efc04}{headers\_out}, bottom, \hyperlink{pcre_8txt_ad7f989d16aa8ca809a36bc392c07fba1}{NULL});
180     \}
181     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (r->\hyperlink{structrequest__rec_a0fd560d8d1118304dc33df8ee99efc04}{headers\_out} != bottom) \{
182         r->\hyperlink{structrequest__rec_a0fd560d8d1118304dc33df8ee99efc04}{headers\_out} = apr\_table\_copy(r->\hyperlink{structrequest__rec_aa0a0c16f9a9ab3901cdb3f3c9c9d83d0}{pool}, bottom);
183     \}
184     apr\_table\_do(remove\_header\_do, r->\hyperlink{structrequest__rec_a0fd560d8d1118304dc33df8ee99efc04}{headers\_out}, top, \hyperlink{pcre_8txt_ad7f989d16aa8ca809a36bc392c07fba1}{NULL});
185     apr\_table\_do(add\_header\_do, r->\hyperlink{structrequest__rec_a0fd560d8d1118304dc33df8ee99efc04}{headers\_out}, top, \hyperlink{pcre_8txt_ad7f989d16aa8ca809a36bc392c07fba1}{NULL});
186 
187     v = apr\_table\_get(r->\hyperlink{structrequest__rec_a0fd560d8d1118304dc33df8ee99efc04}{headers\_out}, \textcolor{stringliteral}{"Content-Type"});
188     \textcolor{keywordflow}{if} (v) \{
189         ap\_set\_content\_type(r, v);
190         \textcolor{comment}{/*}
191 \textcolor{comment}{         * Also unset possible Content-Type headers in r->headers\_out and}
192 \textcolor{comment}{         * r->err\_headers\_out as they may be different to what we have received}
193 \textcolor{comment}{         * from the cache.}
194 \textcolor{comment}{         * Actually they are not needed as r->content\_type set by}
195 \textcolor{comment}{         * ap\_set\_content\_type above will be used in the store\_headers functions}
196 \textcolor{comment}{         * of the storage providers as a fallback and the HTTP\_HEADER filter}
197 \textcolor{comment}{         * does overwrite the Content-Type header with r->content\_type anyway.}
198 \textcolor{comment}{         */}
199         apr\_table\_unset(r->\hyperlink{structrequest__rec_a0fd560d8d1118304dc33df8ee99efc04}{headers\_out}, \textcolor{stringliteral}{"Content-Type"});
200         apr\_table\_unset(r->\hyperlink{structrequest__rec_a691d46e2e4fcf604394aeda5cc6e21e2}{err\_headers\_out}, \textcolor{stringliteral}{"Content-Type"});
201     \}
202 
203     \textcolor{comment}{/* If the cache gave us a Last-Modified header, we can't just}
204 \textcolor{comment}{     * pass it on blindly because of restrictions on future values.}
205 \textcolor{comment}{     */}
206     v = apr\_table\_get(r->\hyperlink{structrequest__rec_a0fd560d8d1118304dc33df8ee99efc04}{headers\_out}, \textcolor{stringliteral}{"Last-Modified"});
207     \textcolor{keywordflow}{if} (v) \{
208         ap\_update\_mtime(r, apr\_date\_parse\_http(v));
209         ap\_set\_last\_modified(r);
210     \}
211 
212 \}
\end{DoxyCode}


Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{group__Cache__storage_ga0b273ea1fdda33adc7ecf2e47e4a57a7_icgraph}
\end{center}
\end{figure}


\index{Cache Storage Functions@{Cache Storage Functions}!cache\+\_\+create\+\_\+entity@{cache\+\_\+create\+\_\+entity}}
\index{cache\+\_\+create\+\_\+entity@{cache\+\_\+create\+\_\+entity}!Cache Storage Functions@{Cache Storage Functions}}
\subsubsection[{\texorpdfstring{cache\+\_\+create\+\_\+entity(cache\+\_\+request\+\_\+rec $\ast$cache, request\+\_\+rec $\ast$r, apr\+\_\+off\+\_\+t size, apr\+\_\+bucket\+\_\+brigade $\ast$in)}{cache_create_entity(cache_request_rec *cache, request_rec *r, apr_off_t size, apr_bucket_brigade *in)}}]{\setlength{\rightskip}{0pt plus 5cm}{\bf int} cache\+\_\+create\+\_\+entity (
\begin{DoxyParamCaption}
\item[{{\bf cache\+\_\+request\+\_\+rec} $\ast$}]{cache, }
\item[{{\bf request\+\_\+rec} $\ast$}]{r, }
\item[{{\bf apr\+\_\+off\+\_\+t}}]{size, }
\item[{{\bf apr\+\_\+bucket\+\_\+brigade} $\ast$}]{in}
\end{DoxyParamCaption}
)}\hypertarget{group__Cache__storage_gaa8317a8938235881e7f1368031b33bb9}{}\label{group__Cache__storage_gaa8317a8938235881e7f1368031b33bb9}

\begin{DoxyCode}
85 \{
86     \hyperlink{structcache__provider__list}{cache\_provider\_list} *\hyperlink{group__APACHE__CORE__PROTO_gaeb6b944e4524f915483b5696b7f2f424}{list};
87     \hyperlink{structcache__handle}{cache\_handle\_t} *\hyperlink{group__apr__hash_ga0d6dcb41ca5e794b318df5f6fd273ee2}{h} = \hyperlink{group__apr__pools_gad214fc0160de3c22b6435e29ea20fce8}{apr\_pcalloc}(r->\hyperlink{structrequest__rec_aa0a0c16f9a9ab3901cdb3f3c9c9d83d0}{pool}, \textcolor{keyword}{sizeof}(
      \hyperlink{structcache__handle}{cache\_handle\_t}));
88     \hyperlink{group__apr__errno_gaa5105fa83cc322f09382292db8b47593}{apr\_status\_t} rv;
89 
90     \textcolor{keywordflow}{if} (!cache) \{
91         \textcolor{comment}{/* This should never happen */}
92         \hyperlink{group__APACHE__CORE__LOG_ga4c112558ccffd6b363da102b2052d2a6}{ap\_log\_rerror}(\hyperlink{group__APACHE__CORE__LOG_ga655e126996849bcb82e4e5a14c616f4a}{APLOG\_MARK}, \hyperlink{group__APACHE__CORE__LOG_ga57ad94ed8c92c4306de90479251a5d58}{APLOG\_ERR}, 
      \hyperlink{group__APR__Error_ga18f5678bea0c2c704a2b6a186c9e158b}{APR\_EGENERAL}, r, \hyperlink{group__APACHE__CORE__LOG_ga1dee8a07e06bc5b3de8b89662c2cd666}{APLOGNO}(00692)
93                 \textcolor{stringliteral}{"cache: No cache request information available for key"}
94                 \textcolor{stringliteral}{" generation"});
95         \textcolor{keywordflow}{return} \hyperlink{group__APR__Error_ga18f5678bea0c2c704a2b6a186c9e158b}{APR\_EGENERAL};
96     \}
97 
98     \textcolor{keywordflow}{if} (!cache->\hyperlink{structcache__request__rec_a564726b5f7e5dc4fee2fb01d178677b4}{key}) \{
99         rv = cache\_generate\_key(r, r->\hyperlink{structrequest__rec_aa0a0c16f9a9ab3901cdb3f3c9c9d83d0}{pool}, &cache->\hyperlink{structcache__request__rec_a564726b5f7e5dc4fee2fb01d178677b4}{key});
100         \textcolor{keywordflow}{if} (rv != \hyperlink{group__apr__errno_ga9ee311b7bf1c691dc521d721339ee2a6}{APR\_SUCCESS}) \{
101             \textcolor{keywordflow}{return} rv;
102         \}
103     \}
104 
105     list = cache->\hyperlink{structcache__request__rec_afeb71f387482c679d90de359869b8e10}{providers};
106     \textcolor{comment}{/* for each specified cache type, delete the URL */}
107     \textcolor{keywordflow}{while} (list) \{
108         \textcolor{keywordflow}{switch} (rv = list->\hyperlink{structcache__provider__list_a1e1caa5b70698f255962728326dc1be3}{provider}->\hyperlink{structcache__provider_a274d91e1289fb324e33ee86c8077c3d0}{create\_entity}(h, r, cache->
      \hyperlink{structcache__request__rec_a564726b5f7e5dc4fee2fb01d178677b4}{key}, \hyperlink{group__APACHE__CORE__CONFIG_ga2bd3edb50f631a96f1b729fde236ff43}{size}, in)) \{
109         \textcolor{keywordflow}{case} \hyperlink{group__APACHE__CORE__DAEMON_gaba51915c87d64af47fb1cc59348961c9}{OK}: \{
110             cache->\hyperlink{structcache__request__rec_ade71ff36fe9a713fd081fa45524151f1}{handle} = \hyperlink{group__apr__hash_ga0d6dcb41ca5e794b318df5f6fd273ee2}{h};
111             cache->\hyperlink{structcache__request__rec_aa97c7f2b0167adee182cce9f2c66b0eb}{provider} = list->\hyperlink{structcache__provider__list_a1e1caa5b70698f255962728326dc1be3}{provider};
112             cache->\hyperlink{structcache__request__rec_ad15b24a12858815a315f37152111b41d}{provider\_name} = list->\hyperlink{structcache__provider__list_a0bd2adbaa02f1aa6af1971fd24b09b6a}{provider\_name};
113             \textcolor{keywordflow}{return} \hyperlink{group__APACHE__CORE__DAEMON_gaba51915c87d64af47fb1cc59348961c9}{OK};
114         \}
115         \textcolor{keywordflow}{case} \hyperlink{group__APACHE__CORE__DAEMON_ga9eba11ca86461a3ae319311d64682dda}{DECLINED}: \{
116             list = list->\hyperlink{structcache__provider__list_a87c07afc8bb63fe7fd2e9274e60341a9}{next};
117             \textcolor{keywordflow}{continue};
118         \}
119         \textcolor{keywordflow}{default}: \{
120             \textcolor{keywordflow}{return} rv;
121         \}
122         \}
123     \}
124     \textcolor{keywordflow}{return} \hyperlink{group__APACHE__CORE__DAEMON_ga9eba11ca86461a3ae319311d64682dda}{DECLINED};
125 \}
\end{DoxyCode}


Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{group__Cache__storage_gaa8317a8938235881e7f1368031b33bb9_icgraph}
\end{center}
\end{figure}


\index{Cache Storage Functions@{Cache Storage Functions}!cache\+\_\+generate\+\_\+key\+\_\+default@{cache\+\_\+generate\+\_\+key\+\_\+default}}
\index{cache\+\_\+generate\+\_\+key\+\_\+default@{cache\+\_\+generate\+\_\+key\+\_\+default}!Cache Storage Functions@{Cache Storage Functions}}
\subsubsection[{\texorpdfstring{cache\+\_\+generate\+\_\+key\+\_\+default(request\+\_\+rec $\ast$r, apr\+\_\+pool\+\_\+t $\ast$p, const char $\ast$$\ast$key)}{cache_generate_key_default(request_rec *r, apr_pool_t *p, const char **key)}}]{\setlength{\rightskip}{0pt plus 5cm}{\bf apr\+\_\+status\+\_\+t} cache\+\_\+generate\+\_\+key\+\_\+default (
\begin{DoxyParamCaption}
\item[{{\bf request\+\_\+rec} $\ast$}]{r, }
\item[{{\bf apr\+\_\+pool\+\_\+t} $\ast$}]{p, }
\item[{const char $\ast$$\ast$}]{key}
\end{DoxyParamCaption}
)}\hypertarget{group__Cache__storage_ga9b9cd90883d10b4e8f021c0cc371a823}{}\label{group__Cache__storage_ga9b9cd90883d10b4e8f021c0cc371a823}

\begin{DoxyCode}
702 \{
703     \textcolor{comment}{/* In early processing (quick-handler, forward proxy), we want the initial}
704 \textcolor{comment}{     * query-string from r->parsed\_uri, since any change before CACHE\_SAVE}
705 \textcolor{comment}{     * shouldn't modify the key. Otherwise we want the actual query-string.}
706 \textcolor{comment}{     */}
707     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *\hyperlink{group__APACHE__CORE__CONFIG_gab559cff0ba49c0f92a0dc777d5730496}{path} = r->\hyperlink{structrequest__rec_aee240e90eac55c732891e9408543990b}{uri};
708     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *\hyperlink{group__APR__Util__DBD_ga1086b66aba6ed16e6853a4cef784f8f6}{query} = r->\hyperlink{structrequest__rec_ad05e275008cdfe1865e02e8774541611}{args};
709     \textcolor{keywordflow}{if} (\hyperlink{group__Cache__util_gaea2f7fee82fd07fce89934bee0939987}{cache\_use\_early\_url}(r)) \{
710         path = r->\hyperlink{structrequest__rec_a778f7883e201095a1d914ab7422635eb}{parsed\_uri}.\hyperlink{structapr__uri__t_a61cff1baadb3c1b52a34b502c25bba7f}{path};
711         query = r->\hyperlink{structrequest__rec_a778f7883e201095a1d914ab7422635eb}{parsed\_uri}.\hyperlink{structapr__uri__t_a88d889bcda9e95696022f04ffb470678}{query};
712     \}
713     \textcolor{keywordflow}{return} cache\_canonicalise\_key(r, p, path, query, &r->\hyperlink{structrequest__rec_a778f7883e201095a1d914ab7422635eb}{parsed\_uri}, 
      \hyperlink{group__MOD__CACHE_ga11d8023381192746eb96be162398fe1c}{key});
714 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=329pt]{group__Cache__storage_ga9b9cd90883d10b4e8f021c0cc371a823_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{group__Cache__storage_ga9b9cd90883d10b4e8f021c0cc371a823_icgraph}
\end{center}
\end{figure}


\index{Cache Storage Functions@{Cache Storage Functions}!cache\+\_\+invalidate@{cache\+\_\+invalidate}}
\index{cache\+\_\+invalidate@{cache\+\_\+invalidate}!Cache Storage Functions@{Cache Storage Functions}}
\subsubsection[{\texorpdfstring{cache\+\_\+invalidate(cache\+\_\+request\+\_\+rec $\ast$cache, request\+\_\+rec $\ast$r)}{cache_invalidate(cache_request_rec *cache, request_rec *r)}}]{\setlength{\rightskip}{0pt plus 5cm}{\bf int} cache\+\_\+invalidate (
\begin{DoxyParamCaption}
\item[{{\bf cache\+\_\+request\+\_\+rec} $\ast$}]{cache, }
\item[{{\bf request\+\_\+rec} $\ast$}]{r}
\end{DoxyParamCaption}
)}\hypertarget{group__Cache__storage_ga8579a258895a1e158ebe9e61deb15d9a}{}\label{group__Cache__storage_ga8579a258895a1e158ebe9e61deb15d9a}
invalidate a specific U\+RL entity in all caches

All cached entities for this U\+RL are removed, usually in response to a P\+O\+S\+T/\+P\+UT or D\+E\+L\+E\+TE.

This function returns OK if at least one entity was found and removed, and D\+E\+C\+L\+I\+N\+ED if no cached entities were removed. 
\begin{DoxyParams}{Parameters}
{\em cache} & \hyperlink{structcache__request__rec}{cache\+\_\+request\+\_\+rec} \\
\hline
{\em r} & \hyperlink{structrequest__rec}{request\+\_\+rec} \\
\hline
\end{DoxyParams}

\begin{DoxyCode}
726 \{
727     \hyperlink{structcache__provider__list}{cache\_provider\_list} *\hyperlink{group__APACHE__CORE__PROTO_gaeb6b944e4524f915483b5696b7f2f424}{list};
728     \hyperlink{group__apr__errno_gaa5105fa83cc322f09382292db8b47593}{apr\_status\_t} rv, \hyperlink{group__APACHE__CORE__HTTPD_ga6e27f49150e9a14580fb313cc2777e00}{status} = \hyperlink{group__APACHE__CORE__DAEMON_ga9eba11ca86461a3ae319311d64682dda}{DECLINED};
729     \hyperlink{structcache__handle}{cache\_handle\_t} *\hyperlink{group__apr__hash_ga0d6dcb41ca5e794b318df5f6fd273ee2}{h};
730     \hyperlink{structapr__uri__t}{apr\_uri\_t} location\_uri;
731     \hyperlink{structapr__uri__t}{apr\_uri\_t} content\_location\_uri;
732 
733     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *\hyperlink{pcre_8txt_ab5ae715589dddf66b4d1eeb056186268}{location}, *location\_key = \hyperlink{pcre_8txt_ad7f989d16aa8ca809a36bc392c07fba1}{NULL};
734     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *content\_location, *content\_location\_key = \hyperlink{pcre_8txt_ad7f989d16aa8ca809a36bc392c07fba1}{NULL};
735 
736     \textcolor{keywordflow}{if} (!cache) \{
737         \textcolor{comment}{/* This should never happen */}
738         \hyperlink{group__APACHE__CORE__LOG_ga4c112558ccffd6b363da102b2052d2a6}{ap\_log\_rerror}(
739                 \hyperlink{group__APACHE__CORE__LOG_ga655e126996849bcb82e4e5a14c616f4a}{APLOG\_MARK}, \hyperlink{group__APACHE__CORE__LOG_ga57ad94ed8c92c4306de90479251a5d58}{APLOG\_ERR}, \hyperlink{group__APR__Error_ga18f5678bea0c2c704a2b6a186c9e158b}{APR\_EGENERAL}, r, 
      \hyperlink{group__APACHE__CORE__LOG_ga1dee8a07e06bc5b3de8b89662c2cd666}{APLOGNO}(00697) \textcolor{stringliteral}{"cache: No cache request information available for key"}
740                 \textcolor{stringliteral}{" generation"});
741         \textcolor{keywordflow}{return} \hyperlink{group__APACHE__CORE__DAEMON_ga9eba11ca86461a3ae319311d64682dda}{DECLINED};
742     \}
743 
744     \textcolor{keywordflow}{if} (!cache->\hyperlink{structcache__request__rec_a564726b5f7e5dc4fee2fb01d178677b4}{key}) \{
745         rv = cache\_generate\_key(r, r->\hyperlink{structrequest__rec_aa0a0c16f9a9ab3901cdb3f3c9c9d83d0}{pool}, &cache->\hyperlink{structcache__request__rec_a564726b5f7e5dc4fee2fb01d178677b4}{key});
746         \textcolor{keywordflow}{if} (rv != \hyperlink{group__apr__errno_ga9ee311b7bf1c691dc521d721339ee2a6}{APR\_SUCCESS}) \{
747             \textcolor{keywordflow}{return} \hyperlink{group__APACHE__CORE__DAEMON_ga9eba11ca86461a3ae319311d64682dda}{DECLINED};
748         \}
749     \}
750 
751     location = apr\_table\_get(r->\hyperlink{structrequest__rec_a0fd560d8d1118304dc33df8ee99efc04}{headers\_out}, \textcolor{stringliteral}{"Location"});
752     \textcolor{keywordflow}{if} (location) \{
753         \textcolor{keywordflow}{if} (apr\_uri\_parse(r->\hyperlink{structrequest__rec_aa0a0c16f9a9ab3901cdb3f3c9c9d83d0}{pool}, location, &location\_uri)
754                 || cache\_canonicalise\_key(r, r->\hyperlink{structrequest__rec_aa0a0c16f9a9ab3901cdb3f3c9c9d83d0}{pool},
755                                           location\_uri.\hyperlink{structapr__uri__t_a61cff1baadb3c1b52a34b502c25bba7f}{path},
756                                           location\_uri.\hyperlink{structapr__uri__t_a88d889bcda9e95696022f04ffb470678}{query},
757                                           &location\_uri, &location\_key)
758                 || !(r->\hyperlink{structrequest__rec_a778f7883e201095a1d914ab7422635eb}{parsed\_uri}.\hyperlink{structapr__uri__t_a8c6bf3dfca3d159f091377d9f7228aec}{hostname}
759                      && location\_uri.\hyperlink{structapr__uri__t_a8c6bf3dfca3d159f091377d9f7228aec}{hostname}
760                      && !strcmp(r->\hyperlink{structrequest__rec_a778f7883e201095a1d914ab7422635eb}{parsed\_uri}.\hyperlink{structapr__uri__t_a8c6bf3dfca3d159f091377d9f7228aec}{hostname},
761                                 location\_uri.\hyperlink{structapr__uri__t_a8c6bf3dfca3d159f091377d9f7228aec}{hostname}))) \{
762             location\_key = \hyperlink{pcre_8txt_ad7f989d16aa8ca809a36bc392c07fba1}{NULL};
763         \}
764     \}
765 
766     content\_location = apr\_table\_get(r->\hyperlink{structrequest__rec_a0fd560d8d1118304dc33df8ee99efc04}{headers\_out}, \textcolor{stringliteral}{"Content-Location"});
767     \textcolor{keywordflow}{if} (content\_location) \{
768         \textcolor{keywordflow}{if} (apr\_uri\_parse(r->\hyperlink{structrequest__rec_aa0a0c16f9a9ab3901cdb3f3c9c9d83d0}{pool}, content\_location,
769                           &content\_location\_uri)
770                 || cache\_canonicalise\_key(r, r->\hyperlink{structrequest__rec_aa0a0c16f9a9ab3901cdb3f3c9c9d83d0}{pool},
771                                           content\_location\_uri.\hyperlink{structapr__uri__t_a61cff1baadb3c1b52a34b502c25bba7f}{path},
772                                           content\_location\_uri.\hyperlink{structapr__uri__t_a88d889bcda9e95696022f04ffb470678}{query},
773                                           &content\_location\_uri,
774                                           &content\_location\_key)
775                 || !(r->\hyperlink{structrequest__rec_a778f7883e201095a1d914ab7422635eb}{parsed\_uri}.\hyperlink{structapr__uri__t_a8c6bf3dfca3d159f091377d9f7228aec}{hostname}
776                      && content\_location\_uri.\hyperlink{structapr__uri__t_a8c6bf3dfca3d159f091377d9f7228aec}{hostname}
777                      && !strcmp(r->\hyperlink{structrequest__rec_a778f7883e201095a1d914ab7422635eb}{parsed\_uri}.\hyperlink{structapr__uri__t_a8c6bf3dfca3d159f091377d9f7228aec}{hostname},
778                                 content\_location\_uri.\hyperlink{structapr__uri__t_a8c6bf3dfca3d159f091377d9f7228aec}{hostname}))) \{
779             content\_location\_key = \hyperlink{pcre_8txt_ad7f989d16aa8ca809a36bc392c07fba1}{NULL};
780         \}
781     \}
782 
783     \textcolor{comment}{/* go through the cache types */}
784     h = apr\_palloc(r->\hyperlink{structrequest__rec_aa0a0c16f9a9ab3901cdb3f3c9c9d83d0}{pool}, \textcolor{keyword}{sizeof}(\hyperlink{structcache__handle}{cache\_handle\_t}));
785 
786     list = cache->\hyperlink{structcache__request__rec_afeb71f387482c679d90de359869b8e10}{providers};
787     
788     \textcolor{keyword}{struct }timespec \hyperlink{group__APACHE__CORE__DAEMON_ga6d3a995932cd00f6b3473898aa90d596}{start}, finish;
789     \textcolor{keywordtype}{double} elapsed = 0;
790     \textcolor{keywordtype}{int} \hyperlink{group__APR__MD5_ga16ff2d8e15ade4948398b0aeb80124a8}{count} = 0;
791     
792 
793 
794 
795     \textcolor{keywordflow}{while} (list) \{
796 
797         \textcolor{comment}{/* invalidate the request uri */}
798     clock\_gettime(CLOCK\_MONOTONIC, &\hyperlink{group__APACHE__CORE__DAEMON_ga6d3a995932cd00f6b3473898aa90d596}{start});
799         rv = list->\hyperlink{structcache__provider__list_a1e1caa5b70698f255962728326dc1be3}{provider}->\hyperlink{structcache__provider_ac99f3fba4c7e207f7a121443f16afe18}{open\_entity}(h, r, cache->\hyperlink{structcache__request__rec_a564726b5f7e5dc4fee2fb01d178677b4}{key});
800     clock\_gettime(CLOCK\_MONOTONIC, &finish);
801     elapsed += (finish.tv\_nsec - \hyperlink{group__APACHE__CORE__DAEMON_ga6d3a995932cd00f6b3473898aa90d596}{start}.tv\_nsec) / 500000000.0;
802     count++;
803         
804     \textcolor{keywordflow}{if} (\hyperlink{group__APACHE__CORE__DAEMON_gaba51915c87d64af47fb1cc59348961c9}{OK} == rv) \{
805             rv = list->\hyperlink{structcache__provider__list_a1e1caa5b70698f255962728326dc1be3}{provider}->\hyperlink{structcache__provider_a77d0de369d305c7bf1886a95518a7b39}{invalidate\_entity}(h, r);
806             status = \hyperlink{group__APACHE__CORE__DAEMON_gaba51915c87d64af47fb1cc59348961c9}{OK};
807         \}
808         \hyperlink{group__APACHE__CORE__LOG_ga4c112558ccffd6b363da102b2052d2a6}{ap\_log\_rerror}(
809                 \hyperlink{group__APACHE__CORE__LOG_ga655e126996849bcb82e4e5a14c616f4a}{APLOG\_MARK}, \hyperlink{group__APACHE__CORE__LOG_gadfcef90537539cf2b7d35cfbbbafeb93}{APLOG\_DEBUG}, rv, r, \hyperlink{group__APACHE__CORE__LOG_ga1dee8a07e06bc5b3de8b89662c2cd666}{APLOGNO}(02468) \textcolor{stringliteral}{"cache:
       Attempted to invalidate cached entity with key: %s"}, cache->\hyperlink{structcache__request__rec_a564726b5f7e5dc4fee2fb01d178677b4}{key});
810 
811         \textcolor{comment}{/* invalidate the Location */}
812         \textcolor{keywordflow}{if} (location\_key) \{
813         clock\_gettime(CLOCK\_MONOTONIC, &\hyperlink{group__APACHE__CORE__DAEMON_ga6d3a995932cd00f6b3473898aa90d596}{start});
814             rv = list->\hyperlink{structcache__provider__list_a1e1caa5b70698f255962728326dc1be3}{provider}->\hyperlink{structcache__provider_ac99f3fba4c7e207f7a121443f16afe18}{open\_entity}(h, r, location\_key);
815         clock\_gettime(CLOCK\_MONOTONIC, &finish);
816         elapsed += (finish.tv\_nsec - \hyperlink{group__APACHE__CORE__DAEMON_ga6d3a995932cd00f6b3473898aa90d596}{start}.tv\_nsec) / 500000000.0;
817         count++;
818             \textcolor{keywordflow}{if} (\hyperlink{group__APACHE__CORE__DAEMON_gaba51915c87d64af47fb1cc59348961c9}{OK} == rv) \{
819                 rv = list->\hyperlink{structcache__provider__list_a1e1caa5b70698f255962728326dc1be3}{provider}->\hyperlink{structcache__provider_a77d0de369d305c7bf1886a95518a7b39}{invalidate\_entity}(h, r);
820                 status = \hyperlink{group__APACHE__CORE__DAEMON_gaba51915c87d64af47fb1cc59348961c9}{OK};
821             \}
822             \hyperlink{group__APACHE__CORE__LOG_ga4c112558ccffd6b363da102b2052d2a6}{ap\_log\_rerror}(
823                     \hyperlink{group__APACHE__CORE__LOG_ga655e126996849bcb82e4e5a14c616f4a}{APLOG\_MARK}, \hyperlink{group__APACHE__CORE__LOG_gadfcef90537539cf2b7d35cfbbbafeb93}{APLOG\_DEBUG}, rv, r, \hyperlink{group__APACHE__CORE__LOG_ga1dee8a07e06bc5b3de8b89662c2cd666}{APLOGNO}(02469) \textcolor{stringliteral}{"cache:
       Attempted to invalidate cached entity with key: %s"}, location\_key);
824         \}
825 
826         \textcolor{comment}{/* invalidate the Content-Location */}
827         \textcolor{keywordflow}{if} (content\_location\_key) \{
828         clock\_gettime(CLOCK\_MONOTONIC, &\hyperlink{group__APACHE__CORE__DAEMON_ga6d3a995932cd00f6b3473898aa90d596}{start});
829             rv = list->\hyperlink{structcache__provider__list_a1e1caa5b70698f255962728326dc1be3}{provider}->\hyperlink{structcache__provider_ac99f3fba4c7e207f7a121443f16afe18}{open\_entity}(h, r, content\_location\_key);
830         clock\_gettime(CLOCK\_MONOTONIC, &finish);
831         elapsed += (finish.tv\_nsec - \hyperlink{group__APACHE__CORE__DAEMON_ga6d3a995932cd00f6b3473898aa90d596}{start}.tv\_nsec) / 500000000.0;
832         count++;
833             \textcolor{keywordflow}{if} (\hyperlink{group__APACHE__CORE__DAEMON_gaba51915c87d64af47fb1cc59348961c9}{OK} == rv) \{
834                 rv = list->\hyperlink{structcache__provider__list_a1e1caa5b70698f255962728326dc1be3}{provider}->\hyperlink{structcache__provider_a77d0de369d305c7bf1886a95518a7b39}{invalidate\_entity}(h, r);
835                 status = \hyperlink{group__APACHE__CORE__DAEMON_gaba51915c87d64af47fb1cc59348961c9}{OK};
836             \}
837             \hyperlink{group__APACHE__CORE__LOG_ga4c112558ccffd6b363da102b2052d2a6}{ap\_log\_rerror}(
838                     \hyperlink{group__APACHE__CORE__LOG_ga655e126996849bcb82e4e5a14c616f4a}{APLOG\_MARK}, \hyperlink{group__APACHE__CORE__LOG_gadfcef90537539cf2b7d35cfbbbafeb93}{APLOG\_DEBUG}, rv, r, \hyperlink{group__APACHE__CORE__LOG_ga1dee8a07e06bc5b3de8b89662c2cd666}{APLOGNO}(02470) \textcolor{stringliteral}{"cache:
       Attempted to invalidate cached entity with key: %s"}, content\_location\_key);
839         \}
840 
841         list = list->\hyperlink{structcache__provider__list_a87c07afc8bb63fe7fd2e9274e60341a9}{next};
842     \}
843 
844     \textcolor{keywordflow}{if} (count != 0) \{
845     elapsed /= \hyperlink{group__APR__MD5_ga16ff2d8e15ade4948398b0aeb80124a8}{count};
846     \hyperlink{group__APACHE__CORE__LOG_ga5e6676c87418af7a1d323a116c78ecb4}{ap\_log\_error}(\hyperlink{group__APACHE__CORE__LOG_ga655e126996849bcb82e4e5a14c616f4a}{APLOG\_MARK}, \hyperlink{group__APACHE__CORE__LOG_ga9f0686ea770c44e205d1c12be74fc21f}{APLOG\_CRIT}, 0, r -> 
      \hyperlink{group__APACHE__CORE__MUTEX_ga32727ee32089d3426d1d6a7280d28228}{server}, \textcolor{stringliteral}{"%lf OPEN\_ENTITY\_2"}, elapsed);    
847     \}
848 
849 
850     \textcolor{keywordflow}{return} \hyperlink{group__APACHE__CORE__HTTPD_ga6e27f49150e9a14580fb313cc2777e00}{status};
851 \}
\end{DoxyCode}


Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=348pt]{group__Cache__storage_ga8579a258895a1e158ebe9e61deb15d9a_icgraph}
\end{center}
\end{figure}


\index{Cache Storage Functions@{Cache Storage Functions}!cache\+\_\+remove\+\_\+url@{cache\+\_\+remove\+\_\+url}}
\index{cache\+\_\+remove\+\_\+url@{cache\+\_\+remove\+\_\+url}!Cache Storage Functions@{Cache Storage Functions}}
\subsubsection[{\texorpdfstring{cache\+\_\+remove\+\_\+url(cache\+\_\+request\+\_\+rec $\ast$cache, request\+\_\+rec $\ast$r)}{cache_remove_url(cache_request_rec *cache, request_rec *r)}}]{\setlength{\rightskip}{0pt plus 5cm}{\bf int} cache\+\_\+remove\+\_\+url (
\begin{DoxyParamCaption}
\item[{{\bf cache\+\_\+request\+\_\+rec} $\ast$}]{cache, }
\item[{{\bf request\+\_\+rec} $\ast$}]{r}
\end{DoxyParamCaption}
)}\hypertarget{group__Cache__storage_ga099a01e4f8a6d68cc94a47adde527489}{}\label{group__Cache__storage_ga099a01e4f8a6d68cc94a47adde527489}
cache\+\_\+storage.\+c 

Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{group__Cache__storage_ga099a01e4f8a6d68cc94a47adde527489_icgraph}
\end{center}
\end{figure}


\index{Cache Storage Functions@{Cache Storage Functions}!cache\+\_\+select@{cache\+\_\+select}}
\index{cache\+\_\+select@{cache\+\_\+select}!Cache Storage Functions@{Cache Storage Functions}}
\subsubsection[{\texorpdfstring{cache\+\_\+select(cache\+\_\+request\+\_\+rec $\ast$cache, request\+\_\+rec $\ast$r)}{cache_select(cache_request_rec *cache, request_rec *r)}}]{\setlength{\rightskip}{0pt plus 5cm}{\bf int} cache\+\_\+select (
\begin{DoxyParamCaption}
\item[{{\bf cache\+\_\+request\+\_\+rec} $\ast$}]{cache, }
\item[{{\bf request\+\_\+rec} $\ast$}]{r}
\end{DoxyParamCaption}
)}\hypertarget{group__Cache__storage_gaffb29f2e1276bc7d81bac540a1cf3e06}{}\label{group__Cache__storage_gaffb29f2e1276bc7d81bac540a1cf3e06}

\begin{DoxyCode}
226 \{
227     \hyperlink{structcache__provider__list}{cache\_provider\_list} *\hyperlink{group__APACHE__CORE__PROTO_gaeb6b944e4524f915483b5696b7f2f424}{list};
228     \hyperlink{group__apr__errno_gaa5105fa83cc322f09382292db8b47593}{apr\_status\_t} rv;
229     \hyperlink{structcache__handle}{cache\_handle\_t} *\hyperlink{group__apr__hash_ga0d6dcb41ca5e794b318df5f6fd273ee2}{h};
230 
231     \textcolor{keywordflow}{if} (!cache) \{
232         \textcolor{comment}{/* This should never happen */}
233         \hyperlink{group__APACHE__CORE__LOG_ga4c112558ccffd6b363da102b2052d2a6}{ap\_log\_rerror}(\hyperlink{group__APACHE__CORE__LOG_ga655e126996849bcb82e4e5a14c616f4a}{APLOG\_MARK}, \hyperlink{group__APACHE__CORE__LOG_ga57ad94ed8c92c4306de90479251a5d58}{APLOG\_ERR}, 
      \hyperlink{group__APR__Error_ga18f5678bea0c2c704a2b6a186c9e158b}{APR\_EGENERAL}, r, \hyperlink{group__APACHE__CORE__LOG_ga1dee8a07e06bc5b3de8b89662c2cd666}{APLOGNO}(00693)
234                 \textcolor{stringliteral}{"cache: No cache request information available for key"}
235                 \textcolor{stringliteral}{" generation"});
236         \textcolor{keywordflow}{return} \hyperlink{group__APACHE__CORE__DAEMON_ga9eba11ca86461a3ae319311d64682dda}{DECLINED};
237     \}
238 
239     \textcolor{comment}{/* if no-cache, we can't serve from the cache, but we may store to the}
240 \textcolor{comment}{     * cache.}
241 \textcolor{comment}{     */}
242     \textcolor{keywordflow}{if} (!\hyperlink{group__Cache__util_ga565962a760117aaaed7e13445f79e831}{ap\_cache\_check\_no\_cache}(cache, r)) \{
243         \textcolor{keywordflow}{return} \hyperlink{group__APACHE__CORE__DAEMON_ga9eba11ca86461a3ae319311d64682dda}{DECLINED};
244     \}
245 
246     \textcolor{keywordflow}{if} (!cache->\hyperlink{structcache__request__rec_a564726b5f7e5dc4fee2fb01d178677b4}{key}) \{
247         rv = cache\_generate\_key(r, r->\hyperlink{structrequest__rec_aa0a0c16f9a9ab3901cdb3f3c9c9d83d0}{pool}, &cache->\hyperlink{structcache__request__rec_a564726b5f7e5dc4fee2fb01d178677b4}{key});
248         \textcolor{keywordflow}{if} (rv != \hyperlink{group__apr__errno_ga9ee311b7bf1c691dc521d721339ee2a6}{APR\_SUCCESS}) \{
249             \textcolor{keywordflow}{return} \hyperlink{group__APACHE__CORE__DAEMON_ga9eba11ca86461a3ae319311d64682dda}{DECLINED};
250         \}
251     \}
252 
253     \textcolor{comment}{/* go through the cache types till we get a match */}
254     h = apr\_palloc(r->\hyperlink{structrequest__rec_aa0a0c16f9a9ab3901cdb3f3c9c9d83d0}{pool}, \textcolor{keyword}{sizeof}(\hyperlink{structcache__handle}{cache\_handle\_t}));
255 
256     list = cache->\hyperlink{structcache__request__rec_afeb71f387482c679d90de359869b8e10}{providers};
257     
258     \textcolor{keyword}{struct }timespec \hyperlink{group__APACHE__CORE__DAEMON_ga6d3a995932cd00f6b3473898aa90d596}{start}, finish;
259     \textcolor{keywordtype}{double} elapsed = 0;
260     \textcolor{keywordtype}{int} \hyperlink{group__APR__MD5_ga16ff2d8e15ade4948398b0aeb80124a8}{count} = 0;
261 
262     \textcolor{keywordflow}{while} (list) \{
263     
264     clock\_gettime(CLOCK\_MONOTONIC, &\hyperlink{group__APACHE__CORE__DAEMON_ga6d3a995932cd00f6b3473898aa90d596}{start});
265         \textcolor{keywordflow}{switch} ((rv = list->\hyperlink{structcache__provider__list_a1e1caa5b70698f255962728326dc1be3}{provider}->\hyperlink{structcache__provider_ac99f3fba4c7e207f7a121443f16afe18}{open\_entity}(h, r, cache->
      \hyperlink{structcache__request__rec_a564726b5f7e5dc4fee2fb01d178677b4}{key}))) \{
266         \textcolor{keywordflow}{case} \hyperlink{group__APACHE__CORE__DAEMON_gaba51915c87d64af47fb1cc59348961c9}{OK}: \{
267         clock\_gettime(CLOCK\_MONOTONIC, &finish);
268         elapsed += (finish.tv\_nsec - \hyperlink{group__APACHE__CORE__DAEMON_ga6d3a995932cd00f6b3473898aa90d596}{start}.tv\_nsec) / 500000000.0;
269         count++;
270             \textcolor{keywordtype}{char} *vary = \hyperlink{pcre_8txt_ad7f989d16aa8ca809a36bc392c07fba1}{NULL};
271             \textcolor{keywordtype}{int} mismatch = 0;
272             \textcolor{keywordtype}{char} *\hyperlink{group__apr__strings_ga882d08c2e3ad3004cdfc219601ebaac8}{last} = \hyperlink{pcre_8txt_ad7f989d16aa8ca809a36bc392c07fba1}{NULL};
273 
274             \textcolor{keywordflow}{if} (list->\hyperlink{structcache__provider__list_a1e1caa5b70698f255962728326dc1be3}{provider}->\hyperlink{structcache__provider_a1ebbc419cb9f93c27620e0fe993dbd18}{recall\_headers}(h, r) != 
      \hyperlink{group__apr__errno_ga9ee311b7bf1c691dc521d721339ee2a6}{APR\_SUCCESS}) \{
275                 \textcolor{comment}{/* try again with next cache type */}
276                 list = list->\hyperlink{structcache__provider__list_a87c07afc8bb63fe7fd2e9274e60341a9}{next};
277                 \textcolor{keywordflow}{continue};
278             \}
279 
280             \textcolor{comment}{/*}
281 \textcolor{comment}{             * Check Content-Negotiation - Vary}
282 \textcolor{comment}{             *}
283 \textcolor{comment}{             * At this point we need to make sure that the object we found in}
284 \textcolor{comment}{             * the cache is the same object that would be delivered to the}
285 \textcolor{comment}{             * client, when the effects of content negotiation are taken into}
286 \textcolor{comment}{             * effect.}
287 \textcolor{comment}{             *}
288 \textcolor{comment}{             * In plain english, we want to make sure that a language-negotiated}
289 \textcolor{comment}{             * document in one language is not given to a client asking for a}
290 \textcolor{comment}{             * language negotiated document in a different language by mistake.}
291 \textcolor{comment}{             *}
292 \textcolor{comment}{             * This code makes the assumption that the storage manager will}
293 \textcolor{comment}{             * cache the req\_hdrs if the response contains a Vary}
294 \textcolor{comment}{             * header.}
295 \textcolor{comment}{             *}
296 \textcolor{comment}{             * RFC2616 13.6 and 14.44 describe the Vary mechanism.}
297 \textcolor{comment}{             */}
298             vary = \hyperlink{group__Cache__util_gada03570414af2b2d9349449858036d90}{cache\_strqtok}(
299                     apr\_pstrdup(r->\hyperlink{structrequest__rec_aa0a0c16f9a9ab3901cdb3f3c9c9d83d0}{pool},
300                             \hyperlink{group__Cache__util_ga46b2ea303b9ec2767a61d0f121835b43}{cache\_table\_getm}(r->\hyperlink{structrequest__rec_aa0a0c16f9a9ab3901cdb3f3c9c9d83d0}{pool}, h->
      \hyperlink{structcache__handle_a66c4c1875bb9740d34ddda4d3e71065e}{resp\_hdrs}, \textcolor{stringliteral}{"Vary"})),
301                     \hyperlink{group__Cache__util_ga2916636af38fdf277cb80c1c698c291a}{CACHE\_SEPARATOR}, &last);
302             \textcolor{keywordflow}{while} (vary) \{
303                 \textcolor{keyword}{const} \textcolor{keywordtype}{char} *\hyperlink{group__apr__hash_ga7424aa17231f37fcf2350b861ca9b549}{h1}, *\hyperlink{group__apr__hash_gaebeb34ebcc8806faa82df3123f4423cf}{h2};
304 
305                 \textcolor{comment}{/*}
306 \textcolor{comment}{                 * is this header in the request and the header in the cached}
307 \textcolor{comment}{                 * request identical? If not, we give up and do a straight get}
308 \textcolor{comment}{                 */}
309                 h1 = \hyperlink{group__Cache__util_ga46b2ea303b9ec2767a61d0f121835b43}{cache\_table\_getm}(r->\hyperlink{structrequest__rec_aa0a0c16f9a9ab3901cdb3f3c9c9d83d0}{pool}, r->\hyperlink{structrequest__rec_a5497da6c01af49acf70a4a9b975c1c83}{headers\_in}, vary);
310                 h2 = \hyperlink{group__Cache__util_ga46b2ea303b9ec2767a61d0f121835b43}{cache\_table\_getm}(r->\hyperlink{structrequest__rec_aa0a0c16f9a9ab3901cdb3f3c9c9d83d0}{pool}, h->\hyperlink{structcache__handle_a3d302af4d74f9067d16e6398f0b709ae}{req\_hdrs}, vary);
311                 \textcolor{keywordflow}{if} (h1 == h2) \{
312                     \textcolor{comment}{/* both headers NULL, so a match - do nothing */}
313                 \}
314                 \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (h1 && h2 && !strcmp(h1, h2)) \{
315                     \textcolor{comment}{/* both headers exist and are equal - do nothing */}
316                 \}
317                 \textcolor{keywordflow}{else} \{
318                     \textcolor{comment}{/* headers do not match, so Vary failed */}
319                     \hyperlink{group__APACHE__CORE__LOG_ga4c112558ccffd6b363da102b2052d2a6}{ap\_log\_rerror}(\hyperlink{group__APACHE__CORE__LOG_ga655e126996849bcb82e4e5a14c616f4a}{APLOG\_MARK}, \hyperlink{group__APACHE__CORE__LOG_gadfcef90537539cf2b7d35cfbbbafeb93}{APLOG\_DEBUG}, 
      \hyperlink{group__apr__errno_ga9ee311b7bf1c691dc521d721339ee2a6}{APR\_SUCCESS},
320                             r, \hyperlink{group__APACHE__CORE__LOG_ga1dee8a07e06bc5b3de8b89662c2cd666}{APLOGNO}(00694) \textcolor{stringliteral}{"cache\_select(): Vary header mismatch."});
321                     mismatch = 1;
322                     \textcolor{keywordflow}{break};
323                 \}
324                 vary = \hyperlink{group__Cache__util_gada03570414af2b2d9349449858036d90}{cache\_strqtok}(\hyperlink{pcre_8txt_ad7f989d16aa8ca809a36bc392c07fba1}{NULL}, \hyperlink{group__Cache__util_ga2916636af38fdf277cb80c1c698c291a}{CACHE\_SEPARATOR}, &last);
325             \}
326 
327             \textcolor{comment}{/* no vary match, try next provider */}
328             \textcolor{keywordflow}{if} (mismatch) \{
329                 \textcolor{comment}{/* try again with next cache type */}
330                 list = list->\hyperlink{structcache__provider__list_a87c07afc8bb63fe7fd2e9274e60341a9}{next};
331                 \textcolor{keywordflow}{continue};
332             \}
333 
334             cache->\hyperlink{structcache__request__rec_aa97c7f2b0167adee182cce9f2c66b0eb}{provider} = list->\hyperlink{structcache__provider__list_a1e1caa5b70698f255962728326dc1be3}{provider};
335             cache->\hyperlink{structcache__request__rec_ad15b24a12858815a315f37152111b41d}{provider\_name} = list->\hyperlink{structcache__provider__list_a0bd2adbaa02f1aa6af1971fd24b09b6a}{provider\_name};
336 
337             \textcolor{comment}{/*}
338 \textcolor{comment}{             * RFC2616 13.3.4 Rules for When to Use Entity Tags and Last-Modified}
339 \textcolor{comment}{             * Dates: An HTTP/1.1 caching proxy, upon receiving a conditional request}
340 \textcolor{comment}{             * that includes both a Last-Modified date and one or more entity tags as}
341 \textcolor{comment}{             * cache validators, MUST NOT return a locally cached response to the}
342 \textcolor{comment}{             * client unless that cached response is consistent with all of the}
343 \textcolor{comment}{             * conditional header fields in the request.}
344 \textcolor{comment}{             */}
345             \textcolor{keywordflow}{if} (ap\_condition\_if\_match(r, h->\hyperlink{structcache__handle_a66c4c1875bb9740d34ddda4d3e71065e}{resp\_hdrs}) == 
      \hyperlink{group__APACHE__CORE__PROTO_gga0c22f044612f116fb81886e73bbce80baa8fec426bc27e2c7c079f92975cc24f9}{AP\_CONDITION\_NOMATCH}
346                     || ap\_condition\_if\_unmodified\_since(r, h->\hyperlink{structcache__handle_a66c4c1875bb9740d34ddda4d3e71065e}{resp\_hdrs})
347                             == \hyperlink{group__APACHE__CORE__PROTO_gga0c22f044612f116fb81886e73bbce80baa8fec426bc27e2c7c079f92975cc24f9}{AP\_CONDITION\_NOMATCH}
348                     || ap\_condition\_if\_none\_match(r, h->\hyperlink{structcache__handle_a66c4c1875bb9740d34ddda4d3e71065e}{resp\_hdrs})
349                             == \hyperlink{group__APACHE__CORE__PROTO_gga0c22f044612f116fb81886e73bbce80baa8fec426bc27e2c7c079f92975cc24f9}{AP\_CONDITION\_NOMATCH}
350                     || ap\_condition\_if\_modified\_since(r, h->\hyperlink{structcache__handle_a66c4c1875bb9740d34ddda4d3e71065e}{resp\_hdrs})
351                             == \hyperlink{group__APACHE__CORE__PROTO_gga0c22f044612f116fb81886e73bbce80baa8fec426bc27e2c7c079f92975cc24f9}{AP\_CONDITION\_NOMATCH}
352                     || ap\_condition\_if\_range(r, h->\hyperlink{structcache__handle_a66c4c1875bb9740d34ddda4d3e71065e}{resp\_hdrs}) == 
      \hyperlink{group__APACHE__CORE__PROTO_gga0c22f044612f116fb81886e73bbce80baa8fec426bc27e2c7c079f92975cc24f9}{AP\_CONDITION\_NOMATCH}) \{
353                 mismatch = 1;
354             \}
355 
356             \textcolor{comment}{/* Is our cached response fresh enough? */}
357             \textcolor{keywordflow}{if} (mismatch || !\hyperlink{group__Cache__util_ga8719ff14e3ad87c32614da9fc10cb119}{cache\_check\_freshness}(h, cache, r)) \{
358                 \textcolor{keyword}{const} \textcolor{keywordtype}{char} *etag, *lastmod;
359 
360                 \textcolor{comment}{/* Cache-Control: only-if-cached and revalidation required, try}
361 \textcolor{comment}{                 * the next provider}
362 \textcolor{comment}{                 */}
363                 \textcolor{keywordflow}{if} (cache->\hyperlink{structcache__request__rec_aaea78b272eb05f1ba67a75bd6264b4df}{control\_in}.\hyperlink{structcache__control_aeca404f2dd16548ae4fbde3592602764}{only\_if\_cached}) \{
364                     \textcolor{comment}{/* try again with next cache type */}
365                     list = list->\hyperlink{structcache__provider__list_a87c07afc8bb63fe7fd2e9274e60341a9}{next};
366                     \textcolor{keywordflow}{continue};
367                 \}
368 
369                 \textcolor{comment}{/* set aside the stale entry for accessing later */}
370                 cache->\hyperlink{structcache__request__rec_a7bdf3605a965ddd6b566babb830bde8b}{stale\_headers} = apr\_table\_copy(r->\hyperlink{structrequest__rec_aa0a0c16f9a9ab3901cdb3f3c9c9d83d0}{pool},
371                         r->\hyperlink{structrequest__rec_a5497da6c01af49acf70a4a9b975c1c83}{headers\_in});
372                 cache->\hyperlink{structcache__request__rec_a17c5946aa60de5806a2af38ef7b91507}{stale\_handle} = \hyperlink{group__apr__hash_ga0d6dcb41ca5e794b318df5f6fd273ee2}{h};
373 
374                 \textcolor{comment}{/* if no existing conditionals, use conditionals of our own */}
375                 \textcolor{keywordflow}{if} (!mismatch) \{
376 
377                     \hyperlink{group__APACHE__CORE__LOG_ga4c112558ccffd6b363da102b2052d2a6}{ap\_log\_rerror}(
378                             \hyperlink{group__APACHE__CORE__LOG_ga655e126996849bcb82e4e5a14c616f4a}{APLOG\_MARK}, \hyperlink{group__APACHE__CORE__LOG_gadfcef90537539cf2b7d35cfbbbafeb93}{APLOG\_DEBUG}, 
      \hyperlink{group__apr__errno_ga9ee311b7bf1c691dc521d721339ee2a6}{APR\_SUCCESS}, r, \hyperlink{group__APACHE__CORE__LOG_ga1dee8a07e06bc5b3de8b89662c2cd666}{APLOGNO}(00695) \textcolor{stringliteral}{"Cached response for %s isn't fresh. Adding "}
379                             \textcolor{stringliteral}{"conditional request headers."}, r->\hyperlink{structrequest__rec_aee240e90eac55c732891e9408543990b}{uri});
380 
381                     \textcolor{comment}{/* Remove existing conditionals that might conflict with ours */}
382                     apr\_table\_unset(r->\hyperlink{structrequest__rec_a5497da6c01af49acf70a4a9b975c1c83}{headers\_in}, \textcolor{stringliteral}{"If-Match"});
383                     apr\_table\_unset(r->\hyperlink{structrequest__rec_a5497da6c01af49acf70a4a9b975c1c83}{headers\_in}, \textcolor{stringliteral}{"If-Modified-Since"});
384                     apr\_table\_unset(r->\hyperlink{structrequest__rec_a5497da6c01af49acf70a4a9b975c1c83}{headers\_in}, \textcolor{stringliteral}{"If-None-Match"});
385                     apr\_table\_unset(r->\hyperlink{structrequest__rec_a5497da6c01af49acf70a4a9b975c1c83}{headers\_in}, \textcolor{stringliteral}{"If-Range"});
386                     apr\_table\_unset(r->\hyperlink{structrequest__rec_a5497da6c01af49acf70a4a9b975c1c83}{headers\_in}, \textcolor{stringliteral}{"If-Unmodified-Since"});
387 
388                     etag = apr\_table\_get(h->\hyperlink{structcache__handle_a66c4c1875bb9740d34ddda4d3e71065e}{resp\_hdrs}, \textcolor{stringliteral}{"ETag"});
389                     lastmod = apr\_table\_get(h->\hyperlink{structcache__handle_a66c4c1875bb9740d34ddda4d3e71065e}{resp\_hdrs}, \textcolor{stringliteral}{"Last-Modified"});
390 
391                     \textcolor{keywordflow}{if} (etag || lastmod) \{
392                         \textcolor{comment}{/* If we have a cached etag and/or Last-Modified add in}
393 \textcolor{comment}{                         * our own conditionals.}
394 \textcolor{comment}{                         */}
395 
396                         \textcolor{keywordflow}{if} (etag) \{
397                             apr\_table\_set(r->\hyperlink{structrequest__rec_a5497da6c01af49acf70a4a9b975c1c83}{headers\_in}, \textcolor{stringliteral}{"If-None-Match"}, etag);
398                         \}
399 
400                         \textcolor{keywordflow}{if} (lastmod) \{
401                             apr\_table\_set(r->\hyperlink{structrequest__rec_a5497da6c01af49acf70a4a9b975c1c83}{headers\_in}, \textcolor{stringliteral}{"If-Modified-Since"},
402                                     lastmod);
403                         \}
404 
405                         \textcolor{comment}{/*}
406 \textcolor{comment}{                         * Do not do Range requests with our own conditionals: If}
407 \textcolor{comment}{                         * we get 304 the Range does not matter and otherwise the}
408 \textcolor{comment}{                         * entity changed and we want to have the complete entity}
409 \textcolor{comment}{                         */}
410                         apr\_table\_unset(r->\hyperlink{structrequest__rec_a5497da6c01af49acf70a4a9b975c1c83}{headers\_in}, \textcolor{stringliteral}{"Range"});
411 
412                     \}
413 
414                 \}
415         
416             \textcolor{keywordflow}{if} (count != 0) \{
417             elapsed /= \hyperlink{group__APR__MD5_ga16ff2d8e15ade4948398b0aeb80124a8}{count};
418             \hyperlink{group__APACHE__CORE__LOG_ga5e6676c87418af7a1d323a116c78ecb4}{ap\_log\_error}(\hyperlink{group__APACHE__CORE__LOG_ga655e126996849bcb82e4e5a14c616f4a}{APLOG\_MARK}, \hyperlink{group__APACHE__CORE__LOG_ga9f0686ea770c44e205d1c12be74fc21f}{APLOG\_CRIT}, 0, r -> 
      \hyperlink{group__APACHE__CORE__MUTEX_ga32727ee32089d3426d1d6a7280d28228}{server}, \textcolor{stringliteral}{"%lf OPEN\_ENTITY"}, elapsed);  
419          \}
420                 \textcolor{comment}{/* ready to revalidate, pretend we were never here */}
421                 \textcolor{keywordflow}{return} \hyperlink{group__APACHE__CORE__DAEMON_ga9eba11ca86461a3ae319311d64682dda}{DECLINED};
422             \}
423 
424             \textcolor{comment}{/* Okay, this response looks okay.  Merge in our stuff and go. */}
425             \hyperlink{group__Cache__storage_ga0b273ea1fdda33adc7ecf2e47e4a57a7}{cache\_accept\_headers}(h, r, h->\hyperlink{structcache__handle_a66c4c1875bb9740d34ddda4d3e71065e}{resp\_hdrs}, r->
      \hyperlink{structrequest__rec_a0fd560d8d1118304dc33df8ee99efc04}{headers\_out}, 0);
426 
427             cache->\hyperlink{structcache__request__rec_ade71ff36fe9a713fd081fa45524151f1}{handle} = \hyperlink{group__apr__hash_ga0d6dcb41ca5e794b318df5f6fd273ee2}{h};
428         
429             \textcolor{keywordflow}{if} (count != 0) \{
430             elapsed /= \hyperlink{group__APR__MD5_ga16ff2d8e15ade4948398b0aeb80124a8}{count};
431             \hyperlink{group__APACHE__CORE__LOG_ga5e6676c87418af7a1d323a116c78ecb4}{ap\_log\_error}(\hyperlink{group__APACHE__CORE__LOG_ga655e126996849bcb82e4e5a14c616f4a}{APLOG\_MARK}, \hyperlink{group__APACHE__CORE__LOG_ga9f0686ea770c44e205d1c12be74fc21f}{APLOG\_CRIT}, 0, r -> 
      \hyperlink{group__APACHE__CORE__MUTEX_ga32727ee32089d3426d1d6a7280d28228}{server}, \textcolor{stringliteral}{"%lf OPEN\_ENTITY"}, elapsed);  
432             \}
433             \textcolor{keywordflow}{return} \hyperlink{group__APACHE__CORE__DAEMON_gaba51915c87d64af47fb1cc59348961c9}{OK};
434         \}
435         \textcolor{keywordflow}{case} \hyperlink{group__APACHE__CORE__DAEMON_ga9eba11ca86461a3ae319311d64682dda}{DECLINED}: \{
436             \textcolor{comment}{/* try again with next cache type */}
437             list = list->\hyperlink{structcache__provider__list_a87c07afc8bb63fe7fd2e9274e60341a9}{next};
438             \textcolor{keywordflow}{continue};
439         \}
440         \textcolor{keywordflow}{default}: \{
441             \textcolor{comment}{/* oo-er! an error */}
442             \textcolor{keywordflow}{return} rv;
443         \}
444         \}
445 
446     \}
447     \textcolor{keywordflow}{if} (count != 0) \{
448     elapsed /= \hyperlink{group__APR__MD5_ga16ff2d8e15ade4948398b0aeb80124a8}{count};
449     \hyperlink{group__APACHE__CORE__LOG_ga5e6676c87418af7a1d323a116c78ecb4}{ap\_log\_error}(\hyperlink{group__APACHE__CORE__LOG_ga655e126996849bcb82e4e5a14c616f4a}{APLOG\_MARK}, \hyperlink{group__APACHE__CORE__LOG_ga9f0686ea770c44e205d1c12be74fc21f}{APLOG\_CRIT}, 0, r -> 
      \hyperlink{group__APACHE__CORE__MUTEX_ga32727ee32089d3426d1d6a7280d28228}{server}, \textcolor{stringliteral}{"%lf OPEN\_ENTITY"}, elapsed);  
450     \}
451 
452     \textcolor{comment}{/* if Cache-Control: only-if-cached, and not cached, return 504 */}
453     \textcolor{keywordflow}{if} (cache->\hyperlink{structcache__request__rec_aaea78b272eb05f1ba67a75bd6264b4df}{control\_in}.\hyperlink{structcache__control_aeca404f2dd16548ae4fbde3592602764}{only\_if\_cached}) \{
454         \hyperlink{group__APACHE__CORE__LOG_ga4c112558ccffd6b363da102b2052d2a6}{ap\_log\_rerror}(\hyperlink{group__APACHE__CORE__LOG_ga655e126996849bcb82e4e5a14c616f4a}{APLOG\_MARK}, \hyperlink{group__APACHE__CORE__LOG_gadfcef90537539cf2b7d35cfbbbafeb93}{APLOG\_DEBUG}, 
      \hyperlink{group__apr__errno_ga9ee311b7bf1c691dc521d721339ee2a6}{APR\_SUCCESS}, r, \hyperlink{group__APACHE__CORE__LOG_ga1dee8a07e06bc5b3de8b89662c2cd666}{APLOGNO}(00696)
455                 \textcolor{stringliteral}{"cache: 'only-if-cached' requested and no cached entity, "}
456                 \textcolor{stringliteral}{"returning 504 Gateway Timeout for: %s"}, r->\hyperlink{structrequest__rec_aee240e90eac55c732891e9408543990b}{uri});
457         \textcolor{keywordflow}{return} \hyperlink{group__HTTP__Status_gaaf973dd6df946c88224a4b761bb079fc}{HTTP\_GATEWAY\_TIME\_OUT};
458     \}
459 
460     \textcolor{keywordflow}{return} \hyperlink{group__APACHE__CORE__DAEMON_ga9eba11ca86461a3ae319311d64682dda}{DECLINED};
461 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{group__Cache__storage_gaffb29f2e1276bc7d81bac540a1cf3e06_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=333pt]{group__Cache__storage_gaffb29f2e1276bc7d81bac540a1cf3e06_icgraph}
\end{center}
\end{figure}


